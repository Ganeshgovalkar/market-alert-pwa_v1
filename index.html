<script>
/* ðŸ”´ STEP 1: put your Google Sheet ID here */
const SHEET_ID = "1QRvMEq1WycUE24UGM5QwKdPACIDDEfQDHbjjixDez3k";

/* Public JSON endpoint */
const SHEET_URL = `https://opensheet.elk.sh/${SHEET_ID}/Sheet1`;

const labels = [];
const niftyData = [];
const sensexData = [];

/* Init chart */
const ctx = document.getElementById("marketChart").getContext("2d");
const chart = new Chart(ctx, {
  type: "line",
  data: {
    labels,
    datasets: [
      {
        label: "Nifty",
        data: niftyData,
        borderColor: "#0F9D58",
        tension: 0.4
      },
      {
        label: "Sensex",
        data: sensexData,
        borderColor: "#C41B46",
        tension: 0.4
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});

/* Fetch REAL market data */
async function updateMarket() {
  try {
    const res = await fetch(SHEET_URL);
    const data = await res.json();

    const nifty = Number(data.find(r => r.nifty)?.nifty);
    const sensex = Number(data.find(r => r.sensex)?.sensex);

    if (!nifty || !sensex) return;

    document.getElementById("niftyVal").innerText = nifty;
    document.getElementById("sensexVal").innerText = sensex;

    const time = new Date().toLocaleTimeString();

    labels.push(time);
    niftyData.push(nifty);
    sensexData.push(sensex);

    if (labels.length > 10) {
      labels.shift();
      niftyData.shift();
      sensexData.shift();
    }

    chart.update();

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${time}</td>
      <td>${nifty}</td>
      <td>${sensex}</td>
    `;
    document.getElementById("historyTable").prepend(row);

  } catch (err) {
    console.error("Market fetch failed", err);
  }
}

function setAlert() {
  document.getElementById("statusBox").innerHTML =
    "<div class='success'>âœ… Alert set successfully</div>";
}

/* Initial + every 5 min */
updateMarket();
setInterval(updateMarket, 300000);
</script>
