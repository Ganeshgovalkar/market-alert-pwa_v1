// -------------------------------
// SIMULATED MARKET DATA (for now)
// -------------------------------
let lastNifty = 21500;
let lastSensex = 71000;

let history = [];
let labels = [];
let niftySeries = [];
let sensexSeries = [];

// Create chart
const ctx = document.getElementById("marketChart").getContext("2d");
const chart = new window.Chart(ctx, {
  type: "line",
  data: {
    labels: labels,
    datasets: [
      {
        label: "Nifty",
        data: niftySeries,
        borderColor: "blue",
        fill: false
      },
      {
        label: "Sensex",
        data: sensexSeries,
        borderColor: "purple",
        fill: false
      }
    ]
  },
  options: {
    responsive: true
  }
});

function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString("en-IN", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });
}

function updateMarketData() {
  const niftyChange = (Math.random() - 0.5) * 200;
  const sensexChange = (Math.random() - 0.5) * 600;

  lastNifty = Math.max(18000, lastNifty + niftyChange);
  lastSensex = Math.max(60000, lastSensex + sensexChange);

  const niftyPercent = (niftyChange / lastNifty) * 100;
  const sensexPercent = (sensexChange / lastSensex) * 100;

  const time = getCurrentTime();

  // Color logic
  const niftyClass = niftyPercent >= 0 ? "up" : "down";
  const sensexClass = sensexPercent >= 0 ? "up" : "down";

  document.getElementById("marketData").innerHTML = `
  ðŸ“Š <b>Market Snapshot</b><br><br>
  Nifty 50: <span class="${niftyClass}">
  ${lastNifty.toFixed(0)} (${niftyPercent.toFixed(2)}%)</span><br>
  Sensex: <span class="${sensexClass}">
  ${lastSensex.toFixed(0)} (${sensexPercent.toFixed(2)}%)</span><br><br>
  â± Last updated: ${time}
  `;

  // Store history
  history.push({
    time,
    nifty: lastNifty.toFixed(0),
    niftyPct: niftyPercent.toFixed(2),
    sensex: lastSensex.toFixed(0),
    sensexPct: sensexPercent.toFixed(2)
  });

  // Keep only last 10 points
  if (history.length > 10) history.shift();

  // Update table
  renderHistory();

  // Update chart
  labels.push(time);
  niftySeries.push(lastNifty);
  sensexSeries.push(lastSensex);

  if (labels.length > 10) {
    labels.shift();
    niftySeries.shift();
    sensexSeries.shift();
  }

  chart.update();
}

function renderHistory() {
  const tbody = document.getElementById("historyTable");
  tbody.innerHTML = "";

  history.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.time}</td>
      <td>${row.nifty}</td>
      <td>${row.niftyPct}%</td>
      <td>${row.sensex}</td>
      <td>${row.sensexPct}%</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------- ALERT LOGIC (ready for WhatsApp later) ----------
document.getElementById("setBtn").addEventListener("click", () => {
  const market = document.getElementById("market").value;
  const time = document.getElementById("alertTime").value;
  const percent = document.getElementById("fallPercent").value;

  if (!time || !percent) {
    alert("Please select time and fall %");
    return;
  }

  localStorage.setItem("market", market);
  localStorage.setItem("alertTime", time);
  localStorage.setItem("fallPercent", percent);

  document.getElementById("statusBox").innerHTML = `
  âœ… Alert Set!<br>
  Market: <b>${market.toUpperCase()}</b><br>
  Trigger: <b>${percent}% fall</b><br>
  Time: <b>${time} IST</b>
  `;
});

// Start + refresh every 5 min
updateMarketData();
setInterval(updateMarketData, 300000);
